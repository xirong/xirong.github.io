#!/usr/bin/env python3
"""
Edge-TTS 音频生成脚本 - 为所有探险家生成新增数学题（题2填空 + 题3比大小）的音频
每个探险家6章 × 2题 × (题目+提示) = 24个新音频，8个探险家共192个
"""

import edge_tts
import asyncio
import os
import re

VOICE = "zh-CN-XiaoxiaoNeural"

# 将数学符号转换为TTS友好的中文
def math_to_chinese(text):
    """把 '6 - 1 = ?' 转换为 '6减1等于几' """
    text = text.replace(' + ', '加').replace(' - ', '减')
    text = text.replace(' = ?', '等于几').replace(' = ？', '等于几')
    # 处理 "10 - 4 = 6" 这种带答案的格式
    text = re.sub(r'\s*=\s*(\d+)', lambda m: f'等于{m.group(1)}', text)
    return text


# ============ 各探险家新增数学题数据 ============
# 格式: planet_name -> [ (ch_id, question_text, hint_text, compare_left, compare_right, compare_hint) ]
# 每章2条: fillin(题2) + compare(题3)

MATH_DATA = {
    "moon": [
        # Ch1
        (1, "fillin", "月球上有4个宇航员，又来了3个，现在一共有几个？", "4加3等于几？"),
        (1, "compare", "比一比，6和1，哪个大？", "6比1大哦！"),
        # Ch2
        (2, "fillin", "碰撞后有9块碎片，飞走了4块，还剩几块？", "9减4等于几？"),
        (2, "compare", "比一比，5和3，哪个大？", "5比3大！大碎片比小碎片多！"),
        # Ch3
        (3, "fillin", "月球绕地球转了2圈，又转了6圈，一共转了几圈？", "2加6等于几？"),
        (3, "compare", "比一比，3和4，哪个大？", "3比4小哦！"),
        # Ch4
        (4, "fillin", "宇航员带了8面旗帜，插了5面，还剩几面？", "8减5等于几？"),
        (4, "compare", "比一比，3和3，哪个大？", "两个都是3，一样多！"),
        # Ch5
        (5, "fillin", "探测器发现了10个陨石坑，有3个被探测过，还有几个没探测？", "10减3等于几？"),
        (5, "compare", "比一比，2和5，哪个大？", "2比5小！小陨石坑比大陨石坑多！"),
        # Ch6
        (6, "fillin", "宇航员带了7瓶氧气，用了4瓶，还剩几瓶？", "7减4等于几？"),
        (6, "compare", "比一比，5和6，哪个大？", "5比6小！"),
    ],
    "sun": [
        # Ch1
        (1, "fillin", "太阳能装下130万个地球！如果搬走了3个地球模型，桌上还剩几个？原来有9个。", "9减3等于几？"),
        (1, "compare", "比一比，9和1，哪个大？", "9比1大！太阳比地球大得多！"),
        # Ch2
        (2, "fillin", "核聚变把4个氢原子变成1个氦原子，用掉了几个氢？", "数一数，一共用了几个？"),
        (2, "compare", "比一比，8和1，哪个大？", "8比1大！光到地球要8分钟，到月球只要1秒多！"),
        # Ch3
        (3, "fillin", "太阳表面温度5500度！如果温度计最高10度，需要2加8等于几个温度计？", "2加8等于几？"),
        (3, "compare", "比一比，10和3，哪个大？", "10比3大！太阳表面比地球热得多！"),
        # Ch4
        (4, "fillin", "太阳上有9个黑子，消失了3个，还剩几个？", "9减3等于几？"),
        (4, "compare", "比一比，5和2，哪个大？", "5比2大！大黑子比小黑子多！"),
        # Ch5
        (5, "fillin", "植物需要阳光才能长大！花园里有3朵红花和4朵黄花，一共几朵？", "3加4等于几？"),
        (5, "compare", "比一比，8和5，哪个大？", "8比5大！夏天白天比黑夜长！"),
        # Ch6
        (6, "fillin", "太阳已经燃烧了46亿年！如果用小火柴来数，6根加上2根是几根？", "6加2等于几？"),
        (6, "compare", "比一比，10和1，哪个大？", "10比1大！红巨星比白矮星大得多！"),
    ],
    "mercury": [
        # Ch1
        (1, "fillin", "水星绕太阳跑了9圈，地球才跑了1圈，水星多跑了几圈？", "9减1等于几？"),
        (1, "compare", "比一比，9和3，哪个大？", "9比3大！水星跑得比地球快多了！"),
        # Ch2
        (2, "fillin", "水星白天很热晚上很冷！温度计白天升了6格，晚上降了4格，还剩几格？", "6减4等于几？"),
        (2, "compare", "比一比，10和0，哪个大？", "10比0大！水星白天比晚上热得多！"),
        # Ch3
        (3, "fillin", "水星表面有10个陨石坑，探测器拍了7个，还有几个没拍到？", "10减7等于几？"),
        (3, "compare", "比一比，4和5，哪个大？", "4比5小！小陨石坑比大陨石坑多！"),
        # Ch4
        (4, "fillin", "水星的一天很长！先算：9减1等于几？", "9减1等于几？"),
        (4, "compare", "比一比，7和4，哪个大？", "7比4大！水星的一天比一年还长！"),
        # Ch5
        (5, "fillin", "水星没有卫星好孤独！木星有5颗大卫星，比水星多几颗？", "5减0等于几？"),
        (5, "compare", "比一比，1和0，哪个大？", "1比0大！地球有月亮，水星没有！"),
        # Ch6
        (6, "fillin", "探测器飞向水星要经过3个行星轨道，再经过2个小行星带，一共经过几个？", "3加2等于几？"),
        (6, "compare", "比一比，6和4，哪个大？", "6比4大！拍的比传回来的多！"),
    ],
    "venus": [
        # Ch1
        (1, "fillin", "金星有2个好朋友来做客，又来了3个，现在一共有几个好朋友？", "2加3等于几？"),
        (1, "compare", "比一比，3和2，哪个大？", "3比2大！金星比水星大哦！"),
        # Ch2
        (2, "fillin", "金星的云层里有4朵黄云和3朵白云，一共有几朵云？", "4加3等于几？"),
        (2, "compare", "比一比，5和3，哪个大？", "5比3大！金星的云层比地球厚！"),
        # Ch3
        (3, "fillin", "金星表面有9块熔岩石，被高温融化了3块，还剩几块？", "9减3等于几？"),
        (3, "compare", "比一比，4和7，哪个大？", "4比7小！金星温度比地球高很多倍！"),
        # Ch4
        (4, "fillin", "金星上太阳从西边升起，小宇航员看了4次日出又看了2次日落，一共看了几次？", "4加2等于几？"),
        (4, "compare", "比一比，2和8，哪个大？", "2比8小！金星转得比地球慢很多！"),
        # Ch5
        (5, "fillin", "雷达拍了10张金星表面照片，有2张模糊了，清晰的有几张？", "10减2等于几？"),
        (5, "compare", "比一比，7和7，哪个大？", "两个都是7！两边一样多！"),
        # Ch6
        (6, "fillin", "金星号探测器坚持了2个小时就坏了，如果新探测器能多坚持4个小时，一共能坚持几个小时？", "2加4等于几？"),
        (6, "compare", "比一比，5和3，哪个大？", "5比3大！拍的照片比发回的多！"),
    ],
    "mars": [
        # Ch1
        (1, "fillin", "火星表面有6块红色石头，风吹走了2块，还剩几块？", "6减2等于几？"),
        (1, "compare", "比一比，4和3，哪个大？", "4比3大！火星排在第4颗，地球排第3颗！"),
        # Ch2
        (2, "fillin", "奥林帕斯山上有5个观测站，又新建了3个，一共有几个？", "5加3等于几？"),
        (2, "compare", "比一比，3和9，哪个大？", "3比9小！奥林帕斯山比珠峰高3倍呢！"),
        # Ch3
        (3, "fillin", "沙尘暴卷起了9粒沙子，落下了4粒，空中还有几粒？", "9减4等于几？"),
        (3, "compare", "比一比，1和8，哪个大？", "1比8小！火星大气只有地球的百分之一！"),
        # Ch4
        (4, "fillin", "火星北极有7块大冰，融化了1块，还有几块？", "7减1等于几？"),
        (4, "compare", "比一比，3和2，哪个大？", "3比2大！找到的冰比岩石多！"),
        # Ch5
        (5, "fillin", "祝融号拍了4张照片，好奇号拍了6张，一共拍了几张？", "4加6等于几？"),
        (5, "compare", "比一比，6和6，哪个大？", "两个都是6，一样多！"),
        # Ch6
        (6, "fillin", "火卫一绕火星转了5圈，火卫二转了3圈，一共转了几圈？", "5加3等于几？"),
        (6, "compare", "比一比，2和1，哪个大？", "2比1大！火星的卫星比地球多！"),
    ],
    "jupiter": [
        # Ch1
        (1, "fillin", "木星能装下10个小星球，已经装了4个，还能装几个？", "10减4等于6！"),
        (1, "compare", "比一比，8和5，哪个大？", "8比5大！"),
        # Ch2
        (2, "fillin", "木星的气体云有3团白色的和4团橙色的，一共有几团？", "3加4等于7！"),
        (2, "compare", "比一比，3和6，哪个大？", "3比6小！"),
        # Ch3
        (3, "fillin", "大红斑的风吹走了9片云，又飘来了1片，还缺几片？", "9减1等于8！"),
        (3, "compare", "比一比，7和7，哪个大？", "7和7一样大！"),
        # Ch4
        (4, "fillin", "木卫二的冰面上有5条裂缝，又发现了3条，一共几条？", "5加3等于8！"),
        (4, "compare", "比一比，4和9，哪个大？", "4比9小！"),
        # Ch5
        (5, "fillin", "木星环上飘着6粒尘埃，飞走了2粒，还剩几粒？", "6减2等于4！"),
        (5, "compare", "比一比，3和7，哪个大？", "3比7小！木星环比土星环少。"),
        # Ch6
        (6, "fillin", "木星吸走了10颗小行星，地球自己挡住了1颗，木星比地球多挡了几颗？", "10减1等于9！"),
        (6, "compare", "比一比，5和3，哪个大？", "5比3大！大石头比小石头多。"),
    ],
    "saturn": [
        # Ch1
        (1, "fillin", "土星环上有8块大冰块，碎掉了2块，还剩几块？", "8减2等于6！"),
        (1, "compare", "比一比，3和4，哪个大？", "3比4小！明亮的环比暗淡的环少。"),
        # Ch2
        (2, "fillin", "土星的密度很小，如果放4个土星和3个木星进游泳池，一共放了几个星球？", "4加3等于7！"),
        (2, "compare", "比一比，5和3，哪个大？", "5比3大！浮着的球比沉下去的多。"),
        # Ch3
        (3, "fillin", "六边形旋风有6条边，普通旋风有0条边，它们相差几条边？", "6减0等于6！"),
        (3, "compare", "比一比，6和6，哪个大？", "6和6一样大！"),
        # Ch4
        (4, "fillin", "土卫六上有9条甲烷河流，干涸了4条，还有几条在流动？", "9减4等于5！"),
        (4, "compare", "比一比，2和4，哪个大？", "2比4小！大湖比小湖少。"),
        # Ch5
        (5, "fillin", "土卫二喷出了10股冰泉，停了3股，还在喷的有几股？", "10减3等于7！"),
        (5, "compare", "比一比，4和2，哪个大？", "4比2大！有冰的卫星比没冰的多。"),
        # Ch6
        (6, "fillin", "卡西尼号飞了7年到土星，中途休息了0年，实际飞行几年？", "7减0等于7！"),
        (6, "compare", "比一比，5和4，哪个大？", "5比4大！土星照片比卫星照片多。"),
    ],
    "neptune": [
        # Ch1
        (1, "fillin", "阳光到海王星要4个多小时，到地球才几分钟。4加3等于几？", "4加3等于7哦！"),
        (1, "compare", "比一比，8和3，哪个大？", "8比3大！海王星离太阳远得多！"),
        # Ch2
        (2, "fillin", "海王星的大小是地球的4倍，比地球多几倍？", "4减1等于3哦！"),
        (2, "compare", "比一比，9和9，哪个大？", "9和9一样大，它们相等！"),
        # Ch3
        (3, "fillin", "大黑斑风暴有10级风力，小风暴有4级，大的比小的多几级？", "10减4等于6哦！"),
        (3, "compare", "比一比，10和3，哪个大？", "10比3大！海王星的风快多了！"),
        # Ch4
        (4, "fillin", "海卫一喷了6次冰泉，停了2次，还在喷的有几次？", "6减2等于4哦！"),
        (4, "compare", "比一比，2和4，哪个大？", "2比4小！第二次喷得更多！"),
        # Ch5
        (5, "fillin", "钻石雨下了8颗钻石，智天捡了5颗，还剩几颗？", "8减5等于3哦！"),
        (5, "compare", "比一比，4和2，哪个大？", "4比2大！钻石比冰块多！"),
        # Ch6
        (6, "fillin", "望远镜看了10颗星星，其中有1颗是海王星，其他的有几颗？", "10减1等于9哦！"),
        (6, "compare", "比一比，3和4，哪个大？", "3比4小！第二次算得更久！"),
    ],
}


def collect_all_audios():
    """收集所有需要生成的音频"""
    audios = []

    for planet, chapters in MATH_DATA.items():
        for ch_id, q_type, question_text, hint_text in chapters:
            prefix = f"audio/{planet}/ch{ch_id}"

            if q_type == "fillin":
                # 题2: 填空题
                audios.append((f"{prefix}-math-2.mp3", question_text))
                audios.append((f"{prefix}-math-2-hint.mp3", hint_text))
            elif q_type == "compare":
                # 题3: 比大小
                audios.append((f"{prefix}-math-3.mp3", question_text))
                audios.append((f"{prefix}-math-3-hint.mp3", hint_text))

    return audios


async def generate_audio(path, text, semaphore):
    """生成单个音频文件"""
    async with semaphore:
        os.makedirs(os.path.dirname(path), exist_ok=True)
        try:
            communicate = edge_tts.Communicate(text, VOICE)
            await communicate.save(path)
            print(f"✓ {path}")
        except Exception as e:
            print(f"✗ {path} - ERROR: {e}")


async def main():
    audios = collect_all_audios()
    print(f"准备生成 {len(audios)} 个音频文件...\n")

    semaphore = asyncio.Semaphore(5)
    tasks = [generate_audio(path, text, semaphore) for path, text in audios]
    await asyncio.gather(*tasks)

    print(f"\n✅ 完成！共生成 {len(audios)} 个音频文件。")


if __name__ == "__main__":
    asyncio.run(main())
